
@model List<Sewa360.Areas.Admin.Models.Manager>

@{
    Layout = "~/Areas/Admin/views/shared/_dashboardlayout.cshtml";
    //Layout = "~/Views/Shared/_dashboardlayout.cshtml";
    var pageSizes = ViewBag.PageSizes as List<int> ?? new List<int> { 5, 10, 20, 50 };
    int currentPageSize = ViewBag.PageSize != null ? (int)ViewBag.PageSize : 10;
    int currentPage = ViewBag.Page != null ? (int)ViewBag.Page : 1;
    int totalPages = ViewBag.TotalPages != null ? (int)ViewBag.TotalPages : 1;
    string search = ViewBag.SearchText ?? "";
}

<!DOCTYPE html>
<html lang="en">
<head>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <style>

        @@media (max-width: 576px) {
            .content-wrapper

        {
            padding: 0.5rem;
        }

        .card {
            width: 98% !important;
            max-width: 98% !important;
            margin: 0 auto;
            border-radius: 1rem;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.08);
        }

        .modal-dialog.modal-lg {
            max-width: 96% !important;
        }

        .form-control {
            font-size: 0.9rem;
            padding: 0.55rem 1rem;
        }

        .modal-body .row .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .btn {
            font-size: 0.9rem;
        }

        table th, table td {
            font-size: 0.8rem;
            white-space: nowrap;
        }

        #dataTableData {
            width: 100%;
            display: block;
            overflow-x: auto;
        }

        }
    </style>

</head>
<body>

    @if (TempData["msg"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert" id="tempMsg">
            @TempData["msg"]
        </div>
    }

    @if (TempData["error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert" id="tempError">
            @TempData["error"]
        </div>
    }

    <div class="content-wrapper">
        <div class="card">
            <div class="card-body">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
                            + Create Manager
                        </button>
                    </div>
                </div>


                <!-- Create User Modal -->
                <div class="modal fade" id="createUserModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <!-- modal-lg for better space -->
                        <div class="modal-content shadow-lg rounded-4">
                            <form asp-action="CreateManager" asp-controller="Admin" method="post">
                                @Html.AntiForgeryToken()
                                <div class="modal-header bg-white rounded-top-4 justify-content-center border-0 flex-column py-4">
                                    <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Create User" class="mb-3" style="width: 70px; height: 70px;">
                                    <h5 class="modal-title fw-bold text-primary text-center">Register New Manager</h5>
                                </div>

                                <div class="modal-body px-4">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">👤 Name</label>
                                            <input name="Manager_Name" class="form-control rounded-pill px-4 py-2" placeholder="Enter username" required />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">🆔 Referral Code</label>
                                            <input name="Manager_Code" class="form-control rounded-pill px-4 py-2" placeholder="Enter referral code" required />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">📞 Contact Number</label>
                                            <input name="Manager_Phone" class="form-control rounded-pill px-4 py-2" placeholder="Enter contact number" required />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">📧 Email</label>
                                            <input name="Manager_Email" type="email" class="form-control rounded-pill px-4 py-2" placeholder="Enter email" required />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">🌆 City</label>
                                            <input name="Manager_City" class="form-control rounded-pill px-4 py-2" placeholder="Enter city" required />
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">🔒 Password</label>
                                            <input name="Manager_Password" type="password" class="form-control rounded-pill px-4 py-2" placeholder="Enter password" required />
                                        </div>

                                        <div class="col-12">
                                            <label class="form-label fw-semibold d-block mb-2">🟢 Status</label>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="IsActive" value="true" />
                                                <label class="form-check-label">Active</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="radio" name="IsActive" value="false" />
                                                <label class="form-check-label">Inactive</label>
                                            </div>
                                        </div>

                                    </div>
                                </div>

                                <div class="modal-footer border-0 pb-4 px-4">
                                    <button type="submit" class="btn btn-success w-100 py-2 fs-5 rounded-pill">Create</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>



                <!-- ✅ Responsive User Table -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle" id="dataTableData">
                        <thead class="table-primary">
                            <tr class="text-center">
                                <th class="text-center">S.No.</th>
                                <th class="text-center">👤 Name</th>
                                <th class="text-center">🆔 Referral Code</th>
                                <th class="text-center">📞 Contact Number</th>
                                <th class="text-center">📧 Email</th>
                                <th class="text-center">🌆 City</th>
                                <th class="text-center">🔒 Password</th>
                                <th class="text-center">🟢 Status</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.Any() == true)
                            {
                                int count = (currentPage - 1) * currentPageSize + 1;
                                foreach (var user in Model)
                                {
                                    <tr class="text-center">
                                        <td class="text-center">@count</td>
                                        <td>@user.Manager_Name</td>
                                        <td>@user.Manager_Code</td>
                                        <td>@user.Manager_Phone</td>
                                        <td>@user.Manager_Email</td>
                                        <td>@user.Manager_City</td>
                                        <td class="text-truncate text-center" style="max-width: 300px;">@user.Manager_Password</td>
                                        <td>
                                            @if (user.IsActive)
                                            {
                                                <span class="badge bg-success">Active</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Inactive</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <!-- Edit User Button (This would typically be inside a loop that lists users) -->
                                            <button type="button" class="btn btn-sm btn-outline-primary me-2"
                                                    data-bs-toggle="modal" data-bs-target="#editUserModal"
                                                    data-id="@user.Manager_Id"
                                                    data-username="@user.Manager_Name"
                                                    data-password="@user.Manager_Password"
                                                    data-idname="@user.Manager_Phone"
                                                     data-companyid="@user.Manager_Code"
                                                     data-allowtowork="@user.Manager_Department"
                                                    data-status="@user.IsActive">
                                                Edit
                                            </button>

                                            <button type="button" class="btn btn-danger btn-sm"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteManagerModal"
                                                    data-id="@user.Manager_Id">
                                                Delete
                                            </button>

                                        </td>
                                    </tr>
                                    count++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted">No users found.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>


               

                    <div class="d-flex justify-content-center align-items-center mt-3 gap-2">
                        <label for="pageSize">Show</label>
                        <select id="pageSize" class="form-select w-auto" style="max-width: 120px;" onchange="changePageSize(this)">
                            @foreach (var size in pageSizes)
                            {
                                var isSelected = size == currentPageSize ? "selected=\"selected\"" : "";
                                <option value="@size" selected>@size</option>
                            }
                        </select>
                        <label>entries</label>
                    </div>
                

                <!-- Delete Modal -->
                <div class="modal fade" id="deleteManagerModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content rounded-4">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Delete</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                Are you sure you want to delete this partner?
                                <input type="hidden" id="deleteManagerId" />
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>







            </div>
        </div>
    </div>


    <script>
        // ✅ Auto-hide temp success/error alerts after 5 seconds
        setTimeout(function () {
            const msg = document.getElementById("tempMsg");
            const error = document.getElementById("tempError");
            if (msg) msg.style.display = 'none';
            if (error) error.style.display = 'none';
        }, 5000);

        // ✅ Change Page Size and Reload with Parameters
        function changePageSize(select) {
            const pageSize = select.value;
            const params = new URLSearchParams(window.location.search);
            params.set("pageSize", pageSize);
            params.set("page", 1); // Reset to page 1 on size change
            params.set("searchText", "@search"); // Razor injects search text
            window.location.search = params.toString();
        }

        document.addEventListener("DOMContentLoaded", function () {
            // ✅ Fill Edit Modal with Button Data
            var editUserButtons = document.querySelectorAll('button[data-bs-toggle="modal"]');
            editUserButtons.forEach(button => {
                button.addEventListener('click', function () {
                    var userId = this.getAttribute('data-id');
                    var userName = this.getAttribute('data-username');
                    var password = this.getAttribute('data-password');
                    var isActive = this.getAttribute('data-status');
                    var companyId = this.getAttribute('data-companyid');

                    document.getElementById('LoginId').value = userId;
                    document.getElementById('UserName').value = userName;
                    document.getElementById('Password').value = password;
                    document.getElementById('CompanyId').value = companyId;

                    if (isActive == '1') {
                        document.getElementById('IsActiveActive').checked = true;
                    } else {
                        document.getElementById('IsActiveInactive').checked = true;
                    }
                });
            });

        //     // ✅ Setup Delete Modal with Confirmation Data
        //            deleteUserModal.addEventListener('show.bs.modal', function (event) {
        //     const button = event.relatedTarget;
        //     const userId = button.getAttribute('data-id');
        //     const userName = button.getAttribute('data-name');

        //     deleteUserModal.querySelector('#deleteLoginId').value = userId;
        //     deleteUserModal.querySelector('#deleteUserName').textContent = userName;
        // });


        // ✅ Optional: Programmatically open edit modal (e.g., from AJAX)
        function openEditModal(user) {
            $('#LoginId').val(user.loginId);
            $('#UserName').val(user.userName);
            $('#Password').val(user.password);
            $('#CompanyId').val(user.companyId);

            if (user.isActive == 1) {
                $('#IsActiveActive').prop('checked', true);
            } else {
                $('#IsActiveInactive').prop('checked', true);
            }

            $('#editUserModal').modal('show');
        }
    </script>


    @section scripts {
        <script src="~/datatable/datatables.min.js"></script>
        <script>
            $(document).ready(function () {
                $('#dataTableData').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    pageLength: 10
                });
            });
        </script>
    }

</body>
</html>
<script>
        let  deleteManagerId= 0;

    // Set ID when modal is shown
    const deleteModal = document.getElementById('deleteManagerModal');
    deleteModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        deleteManagerId = button.getAttribute('data-id');
        document.getElementById('deleteManagerId').value = deleteManagerId;
    });

    // Handle Delete Click
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        $.ajax({

            url: '/Admin/Admin/Delete', // Change to your actual route
            type: 'POST',
            data: { id: deleteManagerId },
            success: function (result) {

                // Hide modal
                $('#deleteManagerModal').modal('hide');

                // Optionally: remove row from table or reload data
                $('#managerRow_' + deleteManagerId).remove(); // If you use IDs for rows
                location.reload();
            },
            error: function () {
                alert("An error occurred while deleting the partner.");
            }
        });
    });
</script>

